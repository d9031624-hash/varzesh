<!doctype html>
<html lang="fa">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <title>اخبار ایران — ساده</title>
  <style>
    :root{font-family: Vazir, Tahoma, Arial;}
    body{margin:0;background:#f7f7f8;color:#111;display:flex;flex-direction:column;align-items:center}
    header{width:100%;background:#fff;border-bottom:1px solid #e5e5e5;padding:12px 16px;box-shadow:0 1px 0 rgba(0,0,0,0.03)}
    .wrap{max-width:980px;width:100%;padding:12px}
    h1{margin:0;font-size:18px}
    #last-refresh{color:#666;font-size:13px;margin-top:6px}
    main{width:100%;padding:12px}
    .card{background:#fff;border-radius:8px;padding:12px;margin-bottom:12px;box-shadow:0 4px 18px rgba(0,0,0,0.04);display:flex;gap:12px}
    .thumb{width:120px;flex:0 0 120px;overflow:hidden;border-radius:6px}
    .thumb img{width:100%;height:100%;object-fit:cover;display:block}
    .meta{flex:1}
    .title{font-weight:700;margin:0 0 6px}
    .desc{color:#333;margin:0 0 8px;font-size:14px}
    .source{font-size:13px;color:#666}
    footer{padding:16px;color:#888;font-size:13px}
    .loading{padding:24px;text-align:center;color:#666}
  </style>
</head>
<body>
  <header>
    <div class="wrap">
      <h1>اخبار ایران (به‌روز هر ۲۰ ثانیه)</h1>
      <div id="last-refresh">در حال بارگذاری...</div>
    </div>
  </header>
  <main class="wrap" id="feed">
    <div class="loading">لطفاً کمی صبر کنید — خبرها در حال بارگیری‌اند...</div>
  </main>
  <footer class="wrap">منابع: خبرگزاری‌های ایرانی (IRNA، ایسنا، فارس، تسنیم و غیره)</footer>

  <script>
    // لیست RSS خبرگزاری‌های ایرانی — اگر خواستید منبع اضافه کنید فقط URL را اضافه کنید
    const RSS_SOURCES = [
      {name: 'IRNA', url: 'https://www.irna.ir/rss'},
      {name: 'ISNA', url: 'https://www.isna.ir/feed'},
      {name: 'Fars', url: 'https://www.farsnews.ir/rss'},
      {name: 'Tasnim', url: 'https://www.tasnimnews.com/fa/rss/allnews'},
      // در صورت نیاز منابع دیگر را اینجا اضافه کنید
    ];

    // برای دور زدن محدودیت CORS از allorigins استفاده می‌کنیم
    // اگر می‌خواهید در سرور واقعی بهتر شود بهتر است یک پروکسی سرور یا تابع سرور (Cloud Function) درست کنید
    function corsFetch(url){
      const proxy = 'https://api.allorigins.win/raw?url=' + encodeURIComponent(url);
      return fetch(proxy).then(r => {
        if(!r.ok) throw new Error('خطا در دریافت RSS');
        return r.text();
      });
    }

    async function fetchFeed(source){
      try{
        const xmlText = await corsFetch(source.url);
        const doc = new DOMParser().parseFromString(xmlText, 'text/xml');
        const items = Array.from(doc.querySelectorAll('item')).map(item => {
          const title = item.querySelector('title')?.textContent || '';
          const link = item.querySelector('link')?.textContent || item.querySelector('guid')?.textContent || '';
          const pub = item.querySelector('pubDate')?.textContent || item.querySelector('dc\\:date')?.textContent || '';
          // تصویر را در چند مکان ممکن است قرار دهند
          let image = '';
          const media = item.querySelector('media\\:content, enclosure');
          if(media && media.getAttribute) image = media.getAttribute('url') || '';
          if(!image){
            // گاهی در توضیحات <img> وجود دارد
            const desc = item.querySelector('description')?.textContent || '';
            const m = desc.match(/<img[^>]+src="([^"]+)"/i);
            if(m) image = m[1];
          }
          const description = item.querySelector('description')?.textContent || '';
          return {title, link, pubDate: new Date(pub || Date.now()), image, description, source: source.name};
        });
        return items;
      }catch(e){
        console.warn('خطا در دریافت از', source.name, e);
        return [];
      }
    }

    async function loadAll(){
      const feedEl = document.getElementById('feed');
      feedEl.innerHTML = '<div class="loading">در حال بارگیری خبرها...</div>';
      const all = await Promise.all(RSS_SOURCES.map(s => fetchFeed(s)));
      const merged = all.flat().filter(Boolean);
      if(merged.length===0){
        feedEl.innerHTML = '<div class="loading">خبر جدیدی پیدا نشد یا سرویس پروکسی در دسترس نیست.</div>';
        return;
      }
      // مرتب‌سازی بر اساس تاریخ
      merged.sort((a,b) => b.pubDate - a.pubDate);
      // نمایش آخرین 40 خبر
      const list = merged.slice(0,40).map(item => {
        return `\n        <article class="card">\n          <div class="thumb">${item.image?`<a href="${item.link}" target="_blank" rel="noopener"><img src="${item.image}" alt=""></a>`:'<div style="width:100%;height:100%;background:#eee;display:flex;align-items:center;justify-content:center;color:#999">عکس ندارد</div>'}</div>\n          <div class="meta">\n            <h2 class="title"><a href="${item.link}" target="_blank" rel="noopener">${escapeHtml(item.title)}</a></h2>\n            <p class="desc">${truncate(stripTags(item.description),220)}</p>\n            <div class="source">${formatDate(item.pubDate)} — ${item.source}</div>\n          </div>\n        </article>\n        `;
      }).join('');
      feedEl.innerHTML = list;
      document.getElementById('last-refresh').textContent = 'آخرین بروزرسانی: ' + formatDate(new Date()) + ' — صفحه هر ۲۰ ثانیه رفرش می‌شود.';
    }

    function stripTags(html){
      return html.replace(/<[^>]*>/g,'').replace(/\s+/g,' ').trim();
    }
    function truncate(text, n){ return text.length>n?text.slice(0,n-1)+'…':text }
    function formatDate(d){
      if(!(d instanceof Date)) d = new Date(d);
      return d.toLocaleString('fa-IR', {year:'numeric',month:'long',day:'numeric',hour:'2-digit',minute:'2-digit'});
    }
    function escapeHtml(str){
      return str.replace(/[&<>"]+/g, function(s){
        return ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;'}[s])||s;
      });
    }

    // بارگذاری اولیه
    loadAll();

    // درخواست کاربر: صفحه واقعا رفرش شود هر ۲۰ ثانیه
    // اگر می‌خواهید به‌جای رفرش کامل فقط محتوا آپدیت شود، خط بعدی را حذف کنید
    setInterval(()=>{
      // انیمیشن سریع قبل از رفرش
      document.body.style.transition = 'opacity 0.4s';
      document.body.style.opacity = '0';
      setTimeout(()=>location.reload(), 450);
    }, 20000);

    // نکته: اگر می‌خواهید بدون رفرش کامل هر 20 ثانیه آپدیت درون صفحه انجام شود، از کد زیر استفاده کنید:
    // setInterval(loadAll, 20000);

  </script>
</body>
</html>
